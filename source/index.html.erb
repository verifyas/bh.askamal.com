<div class="sheet sheet-first absolute bottom-0 z-10 w-full  overflow-y-auto">
  <form class="block p-4 h-full flex flex-col justify-around" onsubmit="return validateForm()">
    <div>
      <div class="text-lg pl-6 pr-6" style="color: #353550;">
        Let's get your details, shall we.
      </div>

      <input type="text" id="userName" placeholder="Elon Musk" class="text w-full pl-6 pr-6 pt-3 pb-3 rounded-full text-lg mt-3" required autofocus autocorrect="off" spellcheck="false">

      <input type="email" id="userEmail" placeholder="elon@spacex.com" class="text w-full pl-6 pr-6 pt-3 pb-3 rounded-full text-lg mt-3" required>
    </div>

    <div>
      <div class="text text-lg pl-6 pr-6 mb-3" style="color: #353550; font-family: Open Sans, Arial;">
        Which banks do you use in Bahrain?
        (pick as many as you like)
      </div>

      <select id="bankSelect" multiple="" size="1">
        <option value="baraka">Al Baraka Islamic Bank</option>
        <option value="alsalam">Alsalam Bank</option>
        <option value="arab">Arab Bank</option>
        <option value="aub">AUB - Ahli United Bank</option>
        <option value="bbk">BBK - Bank of Bahrain and Kuwait</option>
        <option value="bdb">BDB - Bahrain Development Bank</option>
        <option value="bisb">BISB - Bahrain Islamic Bank</option>
        <option value="bnp">BNP Paribas</option>
        <option value="citi">Citibank</option>
        <option value="fab">FAB - First Abu Dhabi Bank</option>
        <option value="future">Future Bank</option>
        <option value="habib">Habib Bank</option>
        <option value="hsbc">HSBC Bank</option>
        <option value="icici">ICICI Bank</option>
        <option value="ila">ila Bank</option>
        <option value="ithmaar">Ithmaar Bank</option>
        <option value="kfh">KFH - Kuwait Finance House</option>
        <option value="khcb">KHCB - Khaleeji Commercial Bank</option>
        <option value="mashreq">Mashreq Bank</option>
        <option value="meem">Meem</option>
        <option value="nbb">NBB - National Bank of Bahrain</option>
        <option value="nbk">NBK - National Bank of Kuwait</option>
        <option value="sc">SC - Standard Chartered</option>
        <option value="ubl">UBL - United Bank Limited</option>
      </select>
    </div>

    <input type="submit" id="btnRegister" class="w-full pl-6 pr-6 pt-3 pb-3 rounded-full text-xl cursor-pointer" style="color: #EFEFF5; font-family: 'Montserrat', sans-serif; background: #3634E3; font-weight: 800;" value="request access">

    <div>
      <img src="/images/logo-gray.svg" title="Amal Logo" class="block m-auto">
      <div class="text-sm text-center mt-3" style="color: #B3B3CB;">
        Amal AI is an authorized participant in the Fintech Regulatory Sandbox in the Kingdom of Bahrain, operating as a Sandbox Ancillary Service Provider
      </div>
    </div>
  </form>
</div>

<div class="sheet absolute bottom-0 z-10 w-full overflow-y-auto">
  <div class="h-full flex flex-col pt-3">
    <div class="flex flex-1 flex-row h-full">
      <div class="h-full flex-1 pl-4 text-lg relative" style="color: #79799e">
        <div class="line absolute overflow-hidden" style="left: 4px; z-index: -1; top: 43px; max-width: 60vw;">
          <img src="/images/line.svg" style="width: 60vw; max-width: unset;">
        </div>
        <div class="pl-3">
          <span class="userName">Ahmed</span>, there are
          <div id="counter" style="font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 3rem; color: #3634e3;line-height: 1.1;letter-spacing:2px;">1,234</div>
          ahead of you in line
        </div>
        <button id="btnRefresh" class="rounded-full mt-2 mb-2 pl-4 pr-4 pt-1 pb-1" style="background: #EBEBF3; color: #626189" onclick="refreshStatus()">
          <svg class="inline-block relative mr-1" style="top: -3px;" width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.325 2.62102C17.9168 2.5838 17.5557 2.88458 17.5185 3.29278L17.4202 4.37153C15.7517 1.75136 12.8556 0 9.49976 0C5.88969 0 2.70823 2.06041 1.12892 5.15283C0.942478 5.51788 1.08728 5.96494 1.45233 6.15138C1.81745 6.33782 2.26444 6.19306 2.45088 5.82797C3.78746 3.21085 6.47149 1.48439 9.49976 1.48439C12.2599 1.48439 14.7507 2.92169 16.1778 5.17339L15.1195 4.41758C14.7859 4.17937 14.3224 4.25663 14.0842 4.59018C13.846 4.92376 13.9232 5.38726 14.2568 5.6255L17.4658 7.91744C17.9362 8.25272 18.5849 7.94579 18.6363 7.38087L18.9967 3.42757C19.034 3.01932 18.7332 2.65824 18.325 2.62102Z" fill="#626189"/>
            <path d="M17.5475 12.8488C17.1824 12.6624 16.7354 12.8072 16.5489 13.1722C15.2123 15.7894 12.5283 17.5158 9.50005 17.5158C6.73994 17.5158 4.24906 16.0785 2.82204 13.8268L3.8803 14.5826C4.21388 14.8208 4.67738 14.7436 4.91562 14.41C5.15383 14.0764 5.07657 13.6129 4.74303 13.3747L1.53396 11.0828C1.06939 10.7509 0.41544 11.0486 0.363486 11.6193L0.00311379 15.5726C-0.0341073 15.9808 0.266667 16.3419 0.674837 16.3791C1.08356 16.4163 1.44416 16.1152 1.48134 15.7074L1.57968 14.6286C3.24806 17.2488 6.14425 19.0002 9.50005 19.0002C13.1101 19.0002 16.2916 16.9398 17.8709 13.8474C18.0573 13.4823 17.9125 13.0353 17.5475 12.8488Z" fill="#626189"/>
            </svg>
            refresh
        </button>
      </div>
      <div class="bg-contain bg-no-repeat" style="background-image:url(/images/amal.svg); width: 200px; max-width: 40vw; background-position: center bottom;"></div>
    </div>

    <div class="h-full pl-4 pr-4 pt-2 pb-4" style="border-top: 1px solid #d4d3e3;">
      <div class="rounded-full pt-1 pl-4 pr-4 pb-1 font-bold mb-2 inline-block" style="color: #1210a2; background: #a3adf5;">HOT TIP</div>
      <div class="text-lg pl-4 pr-2" style="color: #79799e;">
        <strong>Jump <span id="skipSpots">50</span> spots âœ¨</strong> when someone signs up using your link:
      </div>

      <div class="copied">
        Copied!
      </div>

      <div class="rounded-full flex flex-row mt-2 items-center" style="background: #EBEBF3;">
        <div id="user-link" class="flex-1 pl-4 pt-2 pb-2 bg-transparent border-none text-xl overflow-hidden whitespace-no-wrap" style="font-family: Courier New; color: #504C79;">
          <span id="userLink" class="block">amal.is/ðŸ¤—/...</span>
        </div> 

        <div class="copy-icon flex-0 mr-3 ml-1" style="width: 25px;">
          <img src="/images/copy-icon.svg">
        </div>
      </div>

      <div class="text-lg pl-4 pr-4 mt-4 mb-1" style="color: #79799e;">How about a share on:</div>
      <div class="flex flex-row mt-1 justify-around">
        <a class="flex-1 text-lg rounded-full border-2 text-center pt-1 pb-1 font-bold border-green-500 text-green-700" style="max-width: 40vw;" href="javascript:shareOn('whatsapp')">WhatsApp</a>
        <a class="flex-1 text-lg rounded-full border-2 text-center pt-1 pb-1 font-bold border-blue-500 text-blue-700" style="max-width: 40vw;" href="javascript:shareOn('twitter')">Twitter</a>
      </div>
    </div>
  </div>
</div>

<div class="animated-bg"></div>

<div class="flex-col w-full h-full justify-between bg-teal-300 flex overflow-x-hidden" style="background: linear-gradient(180deg, #3E40F8 0%, #3537F8 100%);">
  <div id='topHeading' class="text-3xl text-white text-center mx-4 my-2" style="font-family: 'Montserrat', sans-serif; font-weight: 800; line-height: 1.05;">
    Still guessing where<br>
    itâ€™s all going?
  </div>
  <div id="slides" class="flex flex-1 overflow-y-hidden justify-around relative items-center" >
    <img src="/images/1.svg" draggable="false" class="select-none pointer-events-none max-h-full">
    <img src="/images/2.svg" draggable="false" class="select-none pointer-events-none max-h-full" >
    <img src="/images/3.svg" draggable="false" class="select-none pointer-events-none max-h-full" >
  </div>
  <div id='imageHeading' class="text-2xl text-center text-white font-bold my-2" style="font-family: 'Montserrat', sans-serif; font-weight: 800; line-height: 1.1; color: #ECEEF8;">
    Amal magically breaks <br>
    down your spending
  </div>
  <a class="rounded-full py-2 mx-8 mt-2 mb-4 text-xl text-center cursor-pointer block" style="font-family: 'Montserrat', sans-serif; font-weight: 800; color: #116F2E; background: #67D881;" href="javascript:showRegistrationSheet()">
    get early access
  </a>
</div>

<script>
  var initialX, offsetX, lastClientX, curScreen = 0;
  var screenWidth;
  var numScreens = 3, widthFactor = .65, heightFactor = .9;

  function loadScreen(nextScreen) {
    // Uses the globals numScreens, curScreen, offsetX
    prevScreen = curScreen
    curScreen = clamp(0, numScreens - 1)(nextScreen);
    updateOffset();
    updateHeights();

    if(typeof topHeading != "undefined") hideTopHeading();
    if(prevScreen != curScreen) updateHeadings();
  }

  function hideTopHeading() {
    topHeading.classList.add('off');
    topHeading.addEventListener('transitionend', function() {
      // remove after done
      topHeading.parentNode.removeChild(topHeading);
    });
  }

  // DOM event handlers
  document.addEventListener('DOMContentLoaded', onLoad);

  function onLoad(_) {
    trackReferrer();

    // Register event handlers
    slides.onpointerdown = downHandler;
    slides.onpointercancel = upHandler;
    slides.onpointerup = upHandler;

    updateScreenWidth();
    updateHeights();
    beginAnimating();

    // Initialize dynamic form elements
    window.slimSelect = new SlimSelect({
      select: '#bankSelect',
      placeholder: "Select your bank(s)",
      onChange: () => bankSelect.classList.remove('error'),
      closeOnSelect: false
    });
    
    const clipboard = new ClipboardJS('.copy-icon',
      {
        text: (trigger) => 'https://' + userLink.innerHTML
      });
    clipboard.on('success', showCopiedNotice);
  }

  function trackReferrer() {
    const referrer = location.hash.slice(1);
    location.hash = '';
    if(referrer.length == 0) return;

    // save to persistent storage
    window.localStorage.setItem('referrer', referrer);
  }

  function showRegistrationSheet() {
    const regSheet = document.querySelectorAll('.sheet')[0];
    regSheet.classList.add('in');

    const manager = new Hammer.Manager(regSheet);
    const swipe = new Hammer.Swipe();
    manager.add(swipe);
    manager.on('swipe', function(e) {
      // handle swipe down
      if(e.offsetDirection == 16) regSheet.classList.remove('in');
    });
  }

  function showResultSheet(response, sheetIndex = 0) {

    // response contains name, link, position, skip
    userLink.innerHTML = response['link'];
    document.querySelector('.userName').innerHTML = response['name'];
    skipSpots.innerHTML = response['skip'];

    // show the sheet
    const prevSheet = document.querySelectorAll('.sheet')[sheetIndex];
    prevSheet.classList.remove('in');
    prevSheet.addEventListener('transitionend', function() {
      document.querySelectorAll('.sheet')[1].classList.add('in');
      animateResultSheet(response['position']);
    });

  }

  function animateResultSheet(position) {

    new CountUp('counter', position, { duration: 6 }).start();
    
    // To animate the line, recreate it https://css-tricks.com/restart-css-animation/
    const oldCopy = document.querySelector('.line');
    const newCopy = oldCopy.cloneNode(true);
    oldCopy.parentNode.replaceChild(newCopy, oldCopy);
  }

  function showCopiedNotice() {
    const elem = document.querySelector('.copied');
    elem.classList.add('on');
    setTimeout(() => elem.classList.remove('on'), 2000);
  }

  function downHandler(ev) {
    initialX = ev.clientX;
    slides.style.transitionDuration = '0s';
    slides.onpointermove = moveHandler;
  }

  function moveHandler(ev) {
    lastClientX = ev.clientX;
    var newOffset = offsetX + (ev.clientX - initialX);
    slides.style.transform = `translateX(${newOffset}px)`;
  }

  function upHandler(ev) {
    var offset = 
      ev.clientX == 0 ? // Chrome bug with onPointerCancel
        lastClientX - initialX :
        ev.clientX - initialX;
    var nextScreen;

    slides.style.transitionDuration = '0.3s';
    loadScreen(offset > 0 ? curScreen - 1 : curScreen + 1);

    // release move binding
    slides.onpointermove = null;
  }

  window.addEventListener('resize', updateScreenWidth);

  function updateScreenWidth() {
    screenWidth = document.body.clientWidth;
    widthFactor = screenWidth < 600 ? 0.65 : 0.55; // desktop
    slides.style.width = `${numScreens * screenWidth * widthFactor}px`;
    updateOffset();
  }

  function updateOffset() {
    // When widthFactor < 1, we need to add an offset to center
    // the image presently in focus
    var offsetFromEdge = screenWidth * (1 - widthFactor) / 2;

    // Update offset
    offsetX = -widthFactor * curScreen * screenWidth + offsetFromEdge;
    slides.style.transform = `translateX(${offsetX}px)`;
  }

  function updateHeights() {
    document.querySelectorAll('#slides > img').forEach(function(img, index) {
      var scale = index == curScreen ? 1 : heightFactor;
      img.style.transform = `scale(${scale})`;
    });
  }

  function updateHeadings() {
    imageHeading.classList.add('off');
    imageHeading.addEventListener('transitionend', function() {
      // update text
      imageHeading.innerHTML = HEADINGS[curScreen];
      imageHeading.classList.remove('off');
    });
  }

  // Background related
  const IMAGES = [
    [
      '/images/bg-hand.svg',
      '/images/bg-home.svg',
      '/images/bg-insurance.svg',
      '/images/bg-shopping.svg',
      '/images/bg-eat.svg',
    ],
    [
      '/images/bg-hsbc.svg',
      '/images/bg-bisb.svg',
      '/images/bg-kfh.svg',
      '/images/bg-bbk.svg',
      '/images/bg-ithmaar.svg',
    ],
    [
      '/images/fee-1.svg',
      '/images/fee-2.svg',
      '/images/fee-3.svg',
    ]
  ];
  const HEADINGS = [
    'Amal magically breaks<br> down your spending',
    'All your accounts,<br> all on the same page',
    'Hidden fees,<br>nowhere left to hide',
  ]

  function beginAnimating() {
    // controls:
    // - particle type
    // - heading
    // - speed of particle (by adjusting the animation duration)
    // - rate of particle ejection (particle count / second)
    const root = document.querySelector('.animated-bg');

    window.setInterval(() => 
      requestAnimationFrame(function() {
        const randIndex = Math.ceil( Math.random() * IMAGES[curScreen].length ) - 1;
        const image = IMAGES[curScreen][randIndex];

        const rotation = Math.round(Math.random() * 135) - 135/2;
        const duration = (2 + Math.random() * 2).toFixed(1);
        const scale = 1 + Math.round(Math.random() * 2); // 1 - 3x
        const opacity = (.25 + Math.random()).toFixed(1); // 1 - 3x

        ejectParticle(root, image, `${rotation}deg`, `${duration}s`, scale, opacity);
      }), 800); // TODO: Vary the rate
  }

  function ejectParticle(root, image, rotation, duration, scale, opacity) {
    const particle = document.createElement('div');
    particle.style = `--r:${rotation};--d:${duration};--s:${scale};--o:${opacity}`;
    particle.style.backgroundImage = `url(${image})`;
    root.appendChild(particle);
    particle.addEventListener('animationend', destroyElement);
  }

  function destroyElement(event) {
    if(event.target.parentNode) {
      event.target.parentNode.removeChild(event.target);
    }
  }

  function validateForm() {
    event.preventDefault(); // prevent automatic

    // name, email already checked by browser
    // check banks selected
    const banks = window.slimSelect.selected();
    if(banks.length == 0) {
      bankSelect.classList.add('error');
      return false;
    }

    btnRegister.setAttribute('disabled', 'disabled');
    _submitForm()
      .then(async function(res) {

        _onRegisterSuccess(await res.json());
      })
      .catch((err) => console.error(err))
      .finally((_) => btnRegister.removeAttribute('disabled'));
  }

  function _onRegisterSuccess(obj) {

    const user = obj['link'].split('/').slice(-1)[0];
    window.localStorage.setItem('user', user);

    showResultSheet(obj, 0);
  }

  function _submitForm() {
    opts = {
      'user': {
        'name': userName.value,
        'email': userEmail.value,
        'banks': window.slimSelect.selected(),
        'ref_param': window.localStorage.getItem('referrer')
      }
    }

    return fetch('https://amal.is/users', {
      method: 'post',
      headers: {
      'Content-Type': 'application/json'
      },
      body: JSON.stringify(opts)
    });
  }

  function refreshStatus() {
    const user = window.localStorage.getItem('user');
    btnRefresh.classList.add('disabled');
    btnRefresh.setAttribute('disabled', 'disabled');
    
    fetch(`https://amal.is/status?link=${user}`)
      .then((res) => 
        // appreciate the beauty
        setTimeout(
          async function() {
            btnRefresh.classList.remove('disabled');
            btnRefresh.removeAttribute('disabled');
            showResultSheet(await res.json(), 1);
          }, 
          3500
        ));
  }

  function shareOn(platform) {
    const link = "https://amal.is/%F0%9F%A4%97/" + encodeURI(window.localStorage.getItem('user'));

    var destination;
    switch(platform) {
      case 'twitter':
        var message = "Launching%20in%20Bahrain%20soon,%20and%20early%20users%20get%20free%20access%20for%20life.%20Just%20booked%20my%20spot..";
        destination = `https://twitter.com/intent/tweet/?url=${link}&text=${message}`
        break;
      case 'whatsapp':
        var message = `${link}%0A%0AThey're%20launching%20in%20Bahrain%20soon,%20and%20early%20users%20get%20free%20access%20for%20life.%20Just%20booked%20my%20spot..`;
        destination = `https://wa.me/?text=${message}`;
        break;
    }

    window.open(destination, '_blank');
  }

  const clamp = (min, max) => (value) =>
    value < min ? min : value > max ? max : value;
</script>